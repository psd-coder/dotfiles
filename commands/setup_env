#!/bin/zsh

# Import helpers
source "$(dirname "$0")/helpers"

function setup_iterm2_integration {
  if ! $IS_MACOS; then
    return
  fi

  einf "Setting up iTerm2 shell integration"
  curl -L https://iterm2.com/shell_integration/install_shell_integration_and_utilities.sh | bash

  einf "Configuring iTerm2 to load preferences from dotfiles"
  defaults write com.googlecode.iterm2 PrefsCustomFolder -string "$DOTFILES_CONFIGS"
  defaults write com.googlecode.iterm2 LoadPrefsFromCustomFolder -bool true
}

function setup_env {
  einf "Linking shell configs"

  setup_iterm2_integration
  link "$DOTFILES_SHELL/functions" "$HOME/.functions.sh"
  link "$DOTFILES_SHELL/exports" "$HOME/.exports.sh"
  link "$DOTFILES_SHELL/antidote_zsh_plugins" "$HOME/.zsh_plugins.txt"
  link "$DOTFILES_SHELL/node" "$HOME/.node.sh"
  link "$DOTFILES_SHELL/aliases" "$HOME/.aliases.sh"
  link "$DOTFILES_SHELL/antidote" "$HOME/.antidote.sh"
  link "$DOTFILES_SHELL/profile" "$HOME/.profile"
  link "$DOTFILES_SHELL/bash_profile" "$HOME/.bash_profile"
  link "$DOTFILES_SHELL/zshrc" "$HOME/.zshrc"
  create_dir_if_not_exists "$HOME/.config"
  link "$DOTFILES_SHELL/starship.toml" "$HOME/.config/starship.toml"

  einf "Linking ssh"
  create_dir_if_not_exists "$HOME/.ssh"
  if $IS_MACOS; then
    SSH_CONFIG="$DOTFILES_CONFIGS/ssh/config.darwin"
  else
    SSH_CONFIG="$DOTFILES_CONFIGS/ssh/config.linux"
  fi
  backup_and_link_file "$SSH_CONFIG" "$HOME/.ssh/config" && chmod 0700 "$HOME/.ssh/config"
  backup_and_link_file "$DOTFILES_CONFIGS/ssh/allowed_signers" "$HOME/.ssh/allowed_signers" && chmod 0600 "$HOME/.ssh/allowed_signers"

  # Add GitHub to known_hosts to avoid SSH prompts when cloning
  if ! grep -q "github.com" "$HOME/.ssh/known_hosts" 2>/dev/null; then
    einf "Adding GitHub to SSH known_hosts"
    ssh-keyscan -t ed25519 github.com >> "$HOME/.ssh/known_hosts" 2>/dev/null
  fi

  einf "Linking editor configs"
  VSCODE_CONFIG_DIR="$(get_vscode_config_dir)"
  create_dir_if_not_exists "$VSCODE_CONFIG_DIR"
  create_dir_if_not_exists "$VSCODE_CONFIG_DIR/snippets"
  backup_and_link_file "$DOTFILES_CONFIGS/vscode-settings.json" "$VSCODE_CONFIG_DIR/settings.json"
  backup_and_link_file "$DOTFILES_CONFIGS/vscode-keybindings.json" "$VSCODE_CONFIG_DIR/keybindings.json"
  backup_and_link_file "$DOTFILES_CONFIGS/vscode.code-snippets" "$VSCODE_CONFIG_DIR/snippets/vscode.code-snippets"

  # Karabiner config (macOS only)
  if $IS_MACOS; then
    KARABINER_FOLDER="$HOME/.config/karabiner"
    backup_file "$KARABINER_FOLDER/karabiner.json"
    link "$DOTFILES_CONFIGS/karabiner" "$KARABINER_FOLDER"
  fi

  # Ghostty config
  if $IS_MACOS; then
    einf "Linking Ghostty config"
    backup_file "$HOME/.config/ghostty/config"
    link "$DOTFILES_CONFIGS/ghostty" "$HOME/.config/ghostty"
  fi
  
  # Pre-clone antidote plugins BEFORE linking gitconfig
  # This ensures plugins are cloned via HTTPS (no URL rewrite active yet)
  ANTIDOTE_PATH=""
  if [[ -f "${HOMEBREW_PREFIX:-/opt/homebrew}/opt/antidote/share/antidote/antidote.zsh" ]]; then
    ANTIDOTE_PATH="${HOMEBREW_PREFIX:-/opt/homebrew}/opt/antidote/share/antidote/antidote.zsh"
  elif [[ -f "$HOME/.antidote/antidote.zsh" ]]; then
    ANTIDOTE_PATH="$HOME/.antidote/antidote.zsh"
  fi
  if [[ -n "$ANTIDOTE_PATH" ]]; then
    einf "Pre-cloning antidote plugins via HTTPS"
    source "$ANTIDOTE_PATH"
    antidote bundle < "$HOME/.zsh_plugins.txt" > "$HOME/.zsh_plugins.zsh"
  fi

  einf "Linking git configs"
  link "$DOTFILES_SHELL/gitconfig" "$HOME/.gitconfig"
  link "$DOTFILES_SHELL/gitignore" "$HOME/.gitignore"
}

askdo setup_env "Setup environment?"
