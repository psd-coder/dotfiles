#!/bin/zsh

# import helpers
source `dirname $0`/helpers

# Install brew bundle
function install_brew_bundle {
  ensure_brew
  sudokeepalive

  einf "Updating brew"
  brew update

  einf "Installing brew bundle (taps, casks, brews, vscode extensions)"
  MAS_SKIP=$(grep '^mas ' "$BREW_BUNDLE_FILE" | sed 's/mas "\([^"]*\)".*/\1/' | tr '\n' ' ')
  HOMEBREW_BUNDLE_MAS_SKIP="$MAS_SKIP" brew bundle --file "$BREW_BUNDLE_FILE"
}

function install_mas_apps {
  if ! command -v mas &> /dev/null; then
    eerr "mas not installed, skipping App Store apps"
    return
  fi

  einf "Installing Mac App Store apps"
  grep '^mas ' "$BREW_BUNDLE_FILE" | while read -r line; do
    id=$(echo "$line" | grep -o 'id: [0-9]*' | cut -d' ' -f2)
    name=$(echo "$line" | sed 's/mas "\([^"]*\)".*/\1/')
    einf "Installing $name..."
    mas install "$id"
  done
}

askdo install_brew_bundle "Install brew bundle?"
askdo install_mas_apps "Install Mac App Store apps? (requires Apple ID login)"
