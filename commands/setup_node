#!/bin/zsh

# import helpers
source `dirname $0`/helpers

function ensure_mise {
  if command -v mise &> /dev/null; then
    return 0
  fi

  if $IS_MACOS; then
    ensure_brew_package "mise"
  else
    einf "Installing mise via script"
    curl https://mise.run | sh
    export PATH="$HOME/.local/bin:$PATH"
  fi
}

function setup_node {
  ensure_mise
  eval "$(mise activate zsh)"

  einf "Installing latest LTS node via mise"
  mise use -g node@lts

  # Set PNPM_HOME before using pnpm
  export PNPM_HOME="$(get_pnpm_home)"
  export PATH="$PNPM_HOME:$PATH"

  if ! command -v pnpm &> /dev/null; then
    einf "Installing pnpm"
    corepack enable
    corepack install -g pnpm
  else
    einf "pnpm already installed... skipping"
  fi

  if [[ -f "$NPM_PACKAGES" ]]; then
    einf "Installing global NPM packages"
    while read -r PACKAGE; do
      [[ -z "$PACKAGE" ]] && continue
      einf "Installing $PACKAGE..."
      pnpm add -g "$PACKAGE"
    done < "$NPM_PACKAGES"
  fi
}

askdo setup_node "Setup node installation?"
